---
title: "08 Regression models"
output: 
  html_document:
    keep_md: true
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: hide
    df_print: paged   
---


Regression analysis of hydrographic and plankton variables.
  
Check out package dynlm for including lagged variables - see https://stackoverflow.com/a/13096824/1734247 

## 0. Libraries
```{r}
library(tidyverse)
library(readxl)
library(MASS)
library (ggplot2)
#install.packages("visreg")
library(visreg)
library(vegan)
library(lme4) # for mixed effect models
#install.packages("standardize")
library(standardize) # standardize data for modelling
#install.packages("afex")
library(afex) # adding p-values to lmer output

# library(pander)
```

## 1. Data  
### a. Read
```{r}
dat_a <- read.csv("Data_produced/06_dat_a.csv")
dat_q <- read.csv("Data_produced/06_dat_q.csv")
```

### b. Check variables
```{r}
unique(dat_a$Variable)
```

### c. Make data on broad format
```{r}
dat <- 
  dat_a %>% 
  spread(Variable, Value)
```


### d. Add NAO data
```{r}
df_nao <- read.table("https://climatedataguide.ucar.edu/sites/default/files/nao_station_djfm.txt", skip = 1, header = FALSE)
colnames(df_nao) <- c("Year", "Winter_NAO")

dat <- left_join(dat, df_nao)

```

### e. PCA of environmental variables
```{r environmental PCA, fig.height = 10, fig.width = 10}
tail(dat)

# cannot work with missing values, removing rows with missing
dat.pca <- dat[complete.cases(dat), ]

dim(dat)
dim(dat.pca) # 9 rows removed (9 years)
unique(dat.pca$Year) # mangler noe siden 2011, bør vurdere å fjerne disse parameterne

dat %>%
  summarise_all(funs(sum(is.na(.))))

# ser på miljøvarabelrommet
var.pca <- rda(dat.pca[,-1], scale = TRUE)
envvar  <- data.frame(scores(var.pca, display = "species"))
head(envvar)
years   <- data.frame(scores(var.pca, display = "sites"))

pca_all <- bind_rows(envvar, years)
pca_all$obj <- c(row.names(envvar), dat.pca$Year)
pca_all$type <- c(rep("env", nrow(envvar)), rep("yr", nrow(years)))

envvarplot <- pca_all %>% 
  ggplot(aes(PC1, PC2)) +
  geom_point(data = pca_all[pca_all$type=="yr", ], aes(color = as.numeric(as.character(obj)))) +
  labs(color = "Year") +
  geom_segment(data = pca_all[pca_all$type=="env", ], aes(x=0, xend=PC1*10, y=0, yend=PC2*10), 
                 linetype="dashed", 
                 arrow = arrow(length = unit(0.2, "cm"), type="closed"),
                 size = 0.1, col = "dark gray") +
  geom_text(data = pca_all[pca_all$type=="env", ], aes(x = PC1*10, y = PC2*10, label = obj),  color = "red", size = 3)

  
envvarplot

# Guri to Helene:
# consider removing phytoplankton by f.inst. dplyr::select(-ends_with("_med"))
# make two PCA-ordinations: 
# one for predictors and one for hydrographic responses

```

## 2. Hydrographic data, surface

### a. Surface salinity
```{r}
full_model <- lm(Salinity_Surface ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
```

### b. Surface Total N
```{r}
full_model <- lm(TotN_Surface ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TotN + River_Distant_TotN, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
```


### c. Surface Total P
```{r}
full_model <- lm(TotP_Surface ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TotP + River_Distant_TotP, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
```

### d. Surface TSM
```{r}
full_model <- lm(TSM_Surface ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TOC + River_Distant_TOC, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
par(mfrow = c(2,2), mar = c(4,5,2,1))
plot(step_model)
visreg(step_model, points = list(cex = 1))
```

### e. Siktedyp
```{r}
full_model <- lm(Secchi_Surface ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TotN + River_Distant_TotN + River_Local_TotP + River_Distant_TotP + 
                 River_Local_TOC + River_Distant_TOC, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
visreg(step_model, points = list(cex = 1))

```

## 3. Hydrographic data, intermediate

### a. Intermediate salinity
```{r}
full_model <- lm(Salinity_Intermediate ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
```

### b. Intermediate Total N
```{r}
full_model <- lm(TotN_Intermediate ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TotN + River_Distant_TotN, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
```


### c. Intermediate Total P
```{r}
full_model <- lm(TotP_Intermediate ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TotP + River_Distant_TotP, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
```

### d. Intermediate TSM
```{r}
full_model <- lm(TSM_Intermediate ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TOC + River_Distant_TOC, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
# par(mfrow = c(2,2), mar = c(4,5,2,1))
# plot(step_model)
par(mfrow = c(2,2), mar = c(4,5,2,1))
visreg(step_model, points = list(cex = 1))
```


## 4. Hydrographic data, deep

### a. Deep salinity
```{r}
full_model <- lm(Salinity_Deep ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
```

### b. Deep Total N
```{r}
full_model <- lm(TotN_Deep ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TotN + River_Distant_TotN, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
```


### c. Deep Total P
```{r}
full_model <- lm(TotP_Deep ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TotP + River_Distant_TotP, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
par(mfrow = c(2,2), mar = c(4,5,2,1))
visreg(step_model, points = list(cex = 1))

```

### d. Deep TSM
```{r}
full_model <- lm(TSM_Deep ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TOC + River_Distant_TOC, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
# par(mfrow = c(2,2), mar = c(4,5,2,1))
# plot(step_model)
visreg(step_model, points = list(cex = 1))
```

## 5. Plankton
### a. Kiselalger
```{r}
full_model <- lm(Kiselalger_med ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TotN + River_Distant_TotN + River_Local_TotP + River_Distant_TotP + 
                 River_Local_TOC + River_Distant_TOC, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
par(mfrow = c(2,2), mar = c(4,5,2,1))
visreg(step_model, points = list(cex = 1))

```

### b. Dinoflagellater
```{r}
full_model <- lm(Dinoflagellater_med ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TotN + River_Distant_TotN + River_Local_TotP + River_Distant_TotP + 
                 River_Local_TOC + River_Distant_TOC, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
par(mfrow = c(2,2), mar = c(4,5,2,1))
visreg(step_model, points = list(cex = 1))

```

### c. Flagellater
```{r}
full_model <- lm(Dinoflagellater_med ~ River_Local_Discharge + River_Distant_Discharge + Winter_NAO +
                 River_Local_TotN + River_Distant_TotN + River_Local_TotP + River_Distant_TotP + 
                 River_Local_TOC + River_Distant_TOC, data = dat)
# summary(full_model)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)
par(mfrow = c(2,2), mar = c(4,5,2,1))
visreg(step_model, points = list(cex = 1))

```


# PART TWO - Biologigal data

We're trying to find meaningful ways to describe the relationship between biological paramteres and environmental variables, and connect this to changes that have happened over time.

** Tentative approach: **

* Plot environmental vectors on ordination plots
* Use this to generate hypotheses about causal links
* Test by using models 
  + Probably different models for every system
  + Mixed effects for hard bottom (station as random)
  + GLM for soft bottom (one model per station for DCA at least) and plankton
* Probably makes sense to use the same set of explanatory variables in model selection for every response

## Hard bottom
### Environmental variables in relation to ordination
```{r fitting environmental variables to ordination}
dim(dat)

# retrieving HB parameters
HBdf <- readr::read_csv2("Datasett/Hardbunn_KOPI/HBanalysesett.csv")
names(HBdf)

# coupling the two using dplyr, by Year
HBdat <- # joining and removing phyto from the nix
  HBdf %>% 
    filter(Site %in% c(407, 410)) %>% # filter on stations 407 and 410
    left_join(dat, by = "Year") %>% # join
    dplyr::select(-ends_with("_med")) # remove phytopl

DCAhb <- HBdat %>% 
  dplyr::select(DCA1:DCA4)

envHB <- HBdat %>% 
  dplyr::select(Chla_Deep:Winter_NAO)

envfitHB <- envfit(DCAhb, envHB, na.rm = TRUE, permutations = 999, choices = 1:4)
envfitHB # gives an indication of which parameters may be important for community responses along dca 1, 12 obs fjernes pga NA
str(envfitHB)

plot(DCAhb[1:2])
plot(envfitHB, p.max = 0.01, add = TRUE) # plotting parameters with p-value < 0.01 in relation to ordination. Can make this into a ggplot if needed

HBpar <- names(which(envfitHB$vectors$pvals < 0.01)) # names of parameters with p-value < 0.01
# Must remove phytoplankton
```

### DCA - possible causal links
```{r fitting model for DCA}

# For use as random factor
HBdat$Site <- as.character(HBdat$Site)

# Standarizing
# https://cran.r-project.org/web/packages/standardize/vignettes/using-standardize.html 

HBfullformula <- as.formula(paste("DCA1 ~ ", paste(HBpar, collapse = " + "), "+ (1|Site)", sep = ""))

sHB <- standardize(HBfullformula, HBdat)
HBlmer <- lmer(sHB$formula, sHB$data)

# Model selection
# https://cran.r-project.org/web/packages/lmerTest/lmerTest.pdf 

HBlmer_select <- lmerTest::step(HBlmer) # check envvar for missing values
HBlmer_select

# a bit worried about autocorrelation over time... not sure how much of an issue it is with this kind of data... Dag?

```

## Soft bottom
### Environmental variables in relation to ordination
```{r fitting environmental variables to ordination}
dim(dat)

# retrieving BB ordinations
BB05df <- readr::read_csv2("Data_produced/BBordSites_05.csv")
names(BB05df)
BB35df <- readr::read_csv2("Data_produced/BBordSites_35.csv")
names(BB35df)

# coupling the two using dplyr, by Year
BB05_dat <- # joining and removing phyto from the mix
  BB05df %>% 
    left_join(dat, by = "Year") %>% # join
    dplyr::select(-ends_with("_med")) # remove phytopl

DCA05 <- BB05_dat %>% 
  dplyr::select(DCA1:DCA4)

DCA35 <- BB35df %>% 
  dplyr::select(DCA1:DCA4)

envBB <- BB05_dat %>% 
  dplyr::select(Chla_Deep:Winter_NAO)


BB35_dat <- bind_cols(BB35df[,-1], envBB)

envfitBB05 <- envfit(DCA05, envBB, na.rm = TRUE, permutations = 999, choices = 1:4)
envfitBB05 # gives an indication of which parameters may be important for community responses 
# 6 obs fjernes pga NA
envfitBB35 <- envfit(DCA35, envBB, na.rm = TRUE, permutations = 999, choices = 1:4)
envfitBB35 
# 6 obs fjernes pga NA


plot(DCA05[1:2])
plot(envfitBB05, p.max = 0.05, add = TRUE)
plot(DCA35[1:2])
plot(envfitBB35, p.max = 0.05, add = TRUE)

# plotting parameters with p-value < 0.01 in relation to ordination. Can make this into a ggplot if needed

BB05par <- names(which(envfitBB05$vectors$pvals < 0.05)) # names of parameters with p-value < 0.05
BB35par <- names(which(envfitBB35$vectors$pvals < 0.05)) # names of parameters with p-value < 0.05

```

### DCA - possible causal links
```{r fitting model for DCA}

# Standarizing
# https://cran.r-project.org/web/packages/standardize/vignettes/using-standardize.html 

BB05_fullformula <- as.formula(paste("DCA1 ~ ", paste(BB05par, collapse = " + "), sep = ""))
BB35_fullformula <- as.formula(paste("DCA1 ~ ", paste(BB35par, collapse = " + "), sep = ""))

sBB05 <- standardize(BB05_fullformula, BB05_dat)
sBB35 <- standardize(BB35_fullformula, BB35_dat)

# Model and selection
BB05_lm <- lm(sBB05$formula, sBB05$data)
BB05_select <- stepAIC(BB05_lm, direction = "both") # check envvar for missing values - will this be fixed?
BB05_select

BB05_dat %>%
  summarise_all(funs(sum(is.na(.))))

BB35_lm <- lm(sBB35$formula, sBB35$data)
BB35_select <- stepAIC(BB35_lm, direction = "both") 
BB35_select

```
