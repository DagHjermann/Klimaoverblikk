---
title: "05 Collect annual data of all types"
output: 
  html_document:
    keep_md: true
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: hide
    df_print: paged   
---

Overview:   
* Produces summarized data by year (ending in '_a') and quarter (ending in '_q') 
* Reads data from delivered data files (rivers, hydrology) and ordination (plankton, hard-bottom, soft-bottom)   
* Data produced are written to Data_produced (starting with '05_') for later use   
* No need to add ordination "data" (ie., scores), they are already at annual level 

## 0. Libraries
```{r}
library(tidyverse)
library(readxl)
library(broom)
library(lubridate)
library(zoo)
#install.packages("tidyquant")
library(tidyquant)
install.packages("cowplot")
library(cowplot)
# library(pander)
```

## 1. Folders and files    
Content of folders (see code)  
```{r}
dir("Datasett")
dir("Datasett/River data (from OKA)")
dir("Datasett/hydrografi")
dir("Datasett/Bløtbunn")
dir("Datasett/hardbunn_kopi")
dir("Datasett/Plankton")
```

## 2. River data   
Content of folders (see code)
```{r}
dir("Datasett/River data (from OKA)/Annual mean flows")
dir("Datasett/River data (from OKA)/Monthly loads")
dir("Datasett/River data (from OKA)/Concentrations (individual samples)")
dir("Datasett/River data (from OKA)/Monthly flow-weighted concentrations")
```

### a. Data of monthly river loads and total discharge  
```{r}
df1 <- read_excel("Datasett/River data (from OKA)/Monthly loads/Storelva_monthly loads.xlsx")  
df2 <- read_excel("Datasett/River data (from OKA)/Monthly loads/Gjerstadelva_Nidelva_monthly loads.xlsx")  
df3 <- read_excel("Datasett/River data (from OKA)/Monthly loads/RIDx5_monthly loads.xlsx")  

# head(df1, 3)
# head(df2, 3)
# head(df3, 3)

# colnames(df1) %>% dput()
# colnames(df2) %>% dput()
# colnames(df3) %>% dput()   RID rivers also include PO4, SiO2 and SPM

df_rivers <- bind_rows(df1[-1,], df2[-1,], df3[-1,])

# colnames(df_rivers) %>% dput()
vars <- c("TrspTot TOTN", "TrspTot NO3-N", "TrspTot NH4-N", "TrspTot TOTP",           
          "TrspTot TOC", "TrspTot ALK", "TrspTot Ca", "DisTot")
for (var in vars)
  df_rivers[[var]] <- as.numeric(df_rivers[[var]])
df_rivers$Time <- with(df_rivers, lubridate::ymd(paste(Year, Month, "15")))

# Add "_" in column names (TrspTot Ca -> TrspTot_Ca)
colnames(df_rivers) <- sub(" ", "_", colnames(df_rivers), fixed = TRUE)

# endre rekkefølge på elver fra nord til sør for ggplot
df_rivers$Station_name <- factor(df_rivers$Station_name, levels = c("Glomma ved Sarpsfoss", "Drammenselva", "Numedalslågen", "Skienselva", "Søndeledelva v. Søndeleddammen", "Storelva v/ Nes verk", "Nidelva ovenf. Rygene", "Otra"))

# endre navn på elver
sel <- levels(df_rivers$Station_name) == "Glomma ved Sarpsfoss"; sum(sel)
levels(df_rivers$Station_name)[sel] <- "Glomma"

sel <- levels(df_rivers$Station_name) == "Søndeledelva v. Søndeleddammen"; sum(sel)
levels(df_rivers$Station_name)[sel] <- "Gjerstadelva"

sel <- levels(df_rivers$Station_name) == "Storelva v/ Nes verk"; sum(sel)
levels(df_rivers$Station_name)[sel] <- "Storelva"

sel <- levels(df_rivers$Station_name) == "Nidelva ovenf. Rygene"; sum(sel)
levels(df_rivers$Station_name)[sel] <- "Nidelva"

#levels(df_rivers$Station_name)

# Dropp Otra fra plot og analyser (nedstrøms)
df_rivers <- df_rivers %>% 
  filter(Station_name != "Otra") %>% 
  droplevels()

str(df_rivers)

# rename kolonner
df_rivers <- rename(df_rivers, TotN = TrspTot_TOTN,
                    NO3 = "TrspTot_NO3-N",
                    NH4 = "TrspTot_NH4-N",
                    TotP = TrspTot_TOTP,
                    TOC = TrspTot_TOC,
                    Alkalinity = TrspTot_ALK,
                    Calcium = TrspTot_Ca,
                    Discharge = DisTot,
                    PO4 = "TrspTot_PO4-P",
                    SPM = TrspTot_SPM,
                    Si = TrspTot_SiO2)

#print (df_rivers)

# Table of available data for each river
tb <- df_rivers %>% 
  gather("Variable", Value, TotN:Si) %>%
  filter(!is.na(Value)) %>%
  xtabs(~Station_name + Variable, .)
tb

```

### b. Local rivers, plot monthly mean discharge by station
```{r}
gg <- df_rivers %>%
  filter(substr(Station_name, 1, 4) %in% c("Nide","Gjer","Stor")) %>%
  group_by(Station_name, Month) %>%
  summarise(Mean = mean(Discharge, na.rm = TRUE), 
            Q10 = quantile(Discharge, 0.1, na.rm = TRUE), 
            Q90 = max(Discharge, 0.9, na.rm = TRUE)) %>%
  ggplot(., aes(Month, Mean)) + 
    geom_ribbon(aes(ymin = Q10, ymax = Q90), fill = "lightgreen") +
    geom_line() + geom_point() +
    facet_wrap(~Station_name)
gg
#gg + scale_y_log10()
```

### c. Distant rivers, plot monthly mean discharge by station  
Including Otra
```{r}
gg <- df_rivers %>%
  filter(!substr(Station_name, 1, 4) %in% c("Nide","Gjer","Stor")) %>%
  group_by(Station_name, Month) %>%
  summarise(Mean = mean(Discharge, na.rm = TRUE), 
            Q10 = quantile(Discharge, 0.1, na.rm = TRUE), 
            Q90 = max(Discharge, 0.9, na.rm = TRUE)) %>%
  ggplot(., aes(Month, Mean)) + 
    geom_ribbon(aes(ymin = Q10, ymax = Q90), fill = "lightgreen") +
    geom_line() + geom_point() +
    facet_wrap(~Station_name)
gg
# gg + scale_y_log10()
```

### d. Summarize by "local rivers"/"distant rivers"    
    * Data ending with _a = annual, ending in _q = quarter
    * Exclude Otra  
    
```{r}
df <- df_rivers %>%
  filter(!Station_name %in% "Otra") %>%
  mutate(River_type = 
           ifelse(substr(Station_name, 1, 4) %in% c("Nide","Sønd","Stor"), "Local", "Distant"))

df_rivers_summ_a <- df %>% 
  group_by(River_type, Year) %>%
  summarise_at(c("TotN", "NO3", "TotP", "TOC", "Discharge"), sum, na.rm = TRUE)

df_rivers_summ_q <- df %>%
  mutate(Quarter = case_when(
    Month %in% 1:3 ~ 1,
    Month %in% 4:6 ~ 2,
    Month %in% 7:9 ~ 3,
    Month %in% 10:12 ~ 4
  )) %>%
  group_by(River_type, Year, Quarter) %>%
  summarise_at(c("TotN", "NO3", "TotP", "TOC", "Discharge"), sum, na.rm = TRUE)

```

### e1. Plot annual data  
*Also testing out plotting moving average using tidyquant::geom_ma  
```{r}
# geom_ma: sma= simple moving average, rolling mean over a period defined by n
#geom_ma(ma_fun = SMA, n = 5, linetype = 1, size = 1) +

str (df_rivers_summ_a)

# Annual time series plot with one variable 

##
ggplot(df_rivers_summ_a, aes(Year, Discharge/1E6)) +
  geom_smooth(method = "lm") +
  geom_point() + 
  facet_wrap(~River_type, scales = "free_y") +
  labs(x = "Year", y= "Discharge (/1E6)")

ggplot(df_rivers_summ_a, aes(Year, TotN/1E3)) +
  geom_smooth(method = "lm") +
  geom_point() + 
  facet_wrap(~River_type, scales = "free_y") +
  labs(x = "Year", y= "TotN (/1000)")

df_rivers_summ_a %>%
  gather("Var", "Concentration", TotN, NO3, TotP, TOC) %>%
  #mutate(Var=factor(Var, levels = c("Temperatur", "Salt", "O2")))  %>%
  ggplot(aes(Year, Concentration/1E3, color = River_type)) +
    geom_smooth(method = "lm") +
    geom_point() +
    facet_wrap(~Var, scales = "free_y")


### eksempel med flere vars
df_hydro_summ_a %>%
  gather("Var", "Concentration", Temperatur, Salt, O2) %>%
  mutate(Var=factor(Var, levels = c("Temperatur", "Salt", "O2")))  %>%
  ggplot(aes(Year, Concentration, color = Depth)) +
    geom_smooth(method = "lm") +
    geom_point() +
    facet_wrap(~Var, scales = "free_y")

ggsave ("Figures_rapp/Hydro_1.png", width = 8, height = 6, dpi=500)


ggplot(df_rivers_summ_a, aes(Year,TotN/1E3, color = River_type)) +
  geom_smooth(method = "lm") +
  geom_point() + 
  facet_grid(River_type~., scales = "free_y") +
  labs(x = "Year", y= "Transport TotN (/1000)", color = "River type")

ggplot(df_rivers_summ_a, aes(Year, NO3/1E3, color = River_type)) +
  geom_smooth(method = "lm") +
  geom_point() + 
  facet_grid(River_type~., scales = "free_y") +
  labs(x = "Year", y= "Transport NO3 (/1000)", color = "River type")

ggplot(df_rivers_summ_a, aes(Year, TotP/1E3, color = River_type)) +
  geom_smooth(method = "lm") +
  geom_point() + 
  facet_grid(River_type~., scales = "free_y") +
  labs(x = "Year", y= "Transport TotP (/1000)", color = "River type")

ggplot(df_rivers_summ_a, aes(Year, TOC/1E3, color = River_type)) +
  geom_smooth(method = "lm") +
  geom_point() + 
  facet_grid(River_type~., scales = "free_y") +
  labs(x = "Year", y= "Transport TOC (/1000)", color = "River type")


# Annual time series plot with several variables for each river type

# cannot have two couluns with river type due to large difference in values
#df_rivers_summ_a %>%
 # gather("Variable", "Value", TotN:Discharge) %>%
  #mutate(Value = Value/1E6) %>%
  #ggplot(aes(Year, Value)) +
  #  geom_ma(ma_fun = SMA, n = 5, linetype = 1, size = 1) + 
   # geom_point() +
    #facet_grid(Variable~River_type, scales = "free_y", labeller = label_both)
    #labs(x = "Year", y= "Transports")



# Distant - 
gg1 <- df_rivers_summ_a %>%
  mutate(Discharge = Discharge/1E3) %>%
  gather("Variable", "Value", TotN:Discharge) %>%
  mutate(Value = Value/1E3) %>%
  filter(River_type %in% "Distant") %>%
  ggplot(aes(Year, Value)) + 
    geom_point() +
    geom_smooth() +
    facet_grid(Variable~., scales = "free_y")
gg1

# Local - 
gg2 <- df_rivers_summ_a %>%
  mutate(Discharge = Discharge/1E3) %>%
  gather("Variable", "Value", TotN:Discharge) %>%
  mutate(Value = Value/1E3) %>%
  filter(River_type %in% "Local") %>%
  ggplot(aes(Year, Value)) + 
    geom_point() +
    geom_smooth() +
    facet_grid(Variable~., scales = "free_y")
gg2


# arrange the two plots next to eachother
ggg <- plot_grid(gg1, gg2, labels = c('(Distant)', '(Local)'), ncol = 2)
# For better results, increase margin on left side of plot  
ggg  + theme(plot.margin = margin(12, 6, 6, 32))



```

### e2. Plot quarterly data
```{r}
str(df_rivers_summ_q)

ggplot(df_rivers_summ_q, aes(Year, Discharge/1E6, color = River_type)) +
  geom_smooth() +
  geom_point() + 
  facet_grid(River_type~Quarter, scales = "free_y")

ggplot(df_rivers_summ_q, aes(Year, NO3, color = River_type)) +
  geom_smooth() +
  geom_point() + 
  facet_grid(River_type~Quarter, scales = "free_y")

ggplot(df_rivers_summ_q, aes(Year, TotN, color = River_type)) +
  geom_smooth() +
  geom_point() + 
  facet_grid(River_type~Quarter, scales = "free_y")

ggplot(df_rivers_summ_q, aes(Year, TotP, color = River_type)) +
  geom_smooth() +
  geom_point() + 
  facet_grid(River_type~Quarter, scales = "free_y")

ggplot(df_rivers_summ_q, aes(Year, TOC, color = River_type)) +
  geom_smooth() +
  geom_point() + 
  facet_grid(River_type~Quarter, scales = "free_y")


```

### f. River level: Timing and size of spring flood
```{r}
df_rivers_springflood_allyears <- df_rivers %>%
  group_by(Station_name, Year) %>%
  mutate(DisTot_max = max(DisTot[Month %in% 1:6]), na.rm = TRUE) %>%
  group_by(Station_name) %>%
  summarize(DisTot_max_mean = mean(DisTot_max, na.rm = TRUE))
df_rivers_springflood_allyears

df_rivers_springflood <- df_rivers %>%
  filter(Month %in% 1:6) %>%
  group_by(Station_name, Year) %>%
  mutate(DisTot_max = max(DisTot), na.rm = TRUE) %>%
  group_by(Station_name) %>%
  mutate(DisTot_max_mean = mean(DisTot_max, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(Station_name, Year) %>%
  summarize(DisTot_max_rel = max(DisTot/DisTot_max_mean*100, na.rm = TRUE),
            DisTot_max_month = Month[DisTot == DisTot_max][1],
            DisTot_40perc = Month[DisTot >= 0.40*DisTot_max_mean][1],
            DisTot_60perc = Month[DisTot >= 0.60*DisTot_max_mean][1],
            DisTot_80perc = Month[DisTot >= 0.80*DisTot_max_mean][1])
```


### g1. Plot of max flood
```{r}
ggplot(df_rivers_springflood, aes(Year, DisTot_max_rel)) +
  geom_smooth() + geom_point() +
  facet_wrap(~Station_name)
```

### g2. Plot of flood timing
```{r}
df_rivers_springflood %>%
  gather("Parameter", "Month", DisTot_max_month, DisTot_40perc, DisTot_60perc, DisTot_80perc) %>%
  ggplot(aes(Year, Month, group = Parameter, color = Parameter)) +
  geom_smooth(method = "lm") + geom_point() +
  facet_wrap(~Station_name)
```


### h. River group level: Timing and size of spring flood
```{r}
df_rivergroup <- df_rivers %>%
  filter(!Station_name %in% "Otra") %>%
  mutate(River_type = 
           ifelse(substr(Station_name, 1, 4) %in% c("Nide","Sønd","Stor"), "Local", "Distant")) %>%
  group_by(River_type, Year, Month) %>%
  summarize(DisTot = sum(DisTot, na.rm = TRUE))
  
df_rivergroup_springflood_allyears <- df_rivergroup %>%
  group_by(River_type, Year) %>%
  mutate(DisTot_max = max(DisTot[Month %in% 1:6]), na.rm = TRUE) %>%
  group_by(River_type) %>%
  summarize(DisTot_max_mean = mean(DisTot_max, na.rm = TRUE))
df_rivergroup_springflood_allyears

df_rivergroup_springflood <- df_rivergroup %>%
  filter(Month %in% 1:6) %>%
  group_by(River_type, Year) %>%
  mutate(DisTot_max = max(DisTot), na.rm = TRUE) %>%
  group_by(River_type) %>%
  mutate(DisTot_max_mean = mean(DisTot_max, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(River_type, Year) %>%
  summarize(DisTot_max_rel = max(DisTot/DisTot_max_mean*100, na.rm = TRUE),
            DisTot_max_month = Month[DisTot == DisTot_max][1],
            DisTot_40perc = Month[DisTot >= 0.40*DisTot_max_mean][1],
            DisTot_60perc = Month[DisTot >= 0.60*DisTot_max_mean][1],
            DisTot_80perc = Month[DisTot >= 0.80*DisTot_max_mean][1])

```

### g1. Plot of max flood
```{r}
ggplot(df_rivergroup_springflood, aes(Year, DisTot_max_rel)) +
  geom_smooth() + geom_point() +
  facet_wrap(~River_type)
```

### g2. Plot of flood timing
```{r}
df_rivergroup_springflood %>%
  gather("Parameter", "Month", DisTot_max_month, DisTot_40perc, DisTot_60perc, DisTot_80perc) %>%
  ggplot(aes(Year, Month, group = Parameter, color = Parameter)) +
  geom_smooth(method = "lm") + 
  geom_jitter(width = 0, height = 0.15) +
  facet_wrap(~River_type)
```


### h. Save all
```{r}
write.csv(df_rivers_summ_a, "Data_produced/05_df_rivers_summ_a.csv", row.names = FALSE, quote = FALSE)
write.csv(df_rivers_summ_q, "Data_produced/05_df_rivers_summ_q.csv", row.names = FALSE, quote = FALSE)
write.csv(df_rivergroup_springflood, "Data_produced/05_df_rivergroup_springflood.csv", 
          row.names = FALSE, quote = FALSE)
```


## 3. Hydrological data
### a. Read data
```{r}
load("Datasett/Hydrografi/Arendal_allvars_1990_2016.Rdata")
Df.Arendal$Month <- Df.Arendal$Dato %>% as.character() %>% substr(6,7) %>% as.numeric()
Df.Arendal$Year <- Df.Arendal$Dato %>% as.character() %>% substr(1,4) %>% as.numeric()
Df.Arendal$Time <- ymd_hms(paste(Df.Arendal$Dato, "00:00:00"))   # R's time format
```

### b. Summarize by depth bins and quarter    
    * Depth bins = 0-10, 10-30, 30-50  
    * Quarters starting with February, as with plankton data (section 4c)  
    * For quarters, also see script 04, plot in section 3b  
```{r}
df <- Df.Arendal %>%
  mutate(
    Depth = case_when(
      Depth %in% c(0,5,10) ~ "Surface",
      Depth %in% c(20,30) ~ "Intermediate",
      Depth %in% c(50,75) ~ "Deep")
    )

df_hydro_summ_a <- df %>%
  group_by(Year, Depth) %>%
  summarize_at(vars(Temperatur:Siktdyp), mean, na.rm = TRUE)

df_hydro_summ_q <- df %>%
  mutate(
    Quarter = case_when(
      Month %in% 1 ~ 4,
      Month %in% 2:4 ~ 1,
      Month %in% 5:7 ~ 2,
      Month %in% 8:10 ~ 3,
      Month %in% 11:12 ~ 4),
    Year2 = case_when(
      Month == 1 ~ Year - 1,
      Month > 1 ~ Year)
    ) %>%
  group_by(Year2, Quarter, Depth) %>%
  summarize_at(vars(Temperatur:Siktdyp), mean, na.rm = TRUE) %>%
  rename(Year = Year2)

df_hydro_summ_a$Depth <- factor(df_hydro_summ_a$Depth, 
                                 levels = c("Surface", "Intermediate", "Deep"))
df_hydro_summ_q$Depth <- factor(df_hydro_summ_q$Depth, 
                                 levels = c("Surface", "Intermediate", "Deep"))

# summere til DIN
df_hydro_summ_a$DIN <- df_hydro_summ_a$NO2_NO3 + df_hydro_summ_a$NH4

```

### c. Save
```{r}
write.csv(df_hydro_summ_a, "Data_produced/05_df_hydro_summ_a.csv", row.names = FALSE, quote = FALSE)
write.csv(df_hydro_summ_q, "Data_produced/05_df_hydro_summ_q.csv", row.names = FALSE, quote = FALSE)
```

### d1. Plot temperature, annual
```{r}
ggplot(df_hydro_summ_a, aes(Year, Temperatur, color = Depth)) +
  geom_smooth() + 
  geom_point()
```

### d2. Plot enkeltvariable by quarter
```{r}
#str (df_hydro_summ_q)

# heller bruke sma?
#til geom_smooth: method = "lm"

ggplot(df_hydro_summ_q, aes(Year, Temperatur, color = Depth)) +
  geom_smooth() + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, Salt, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, O2, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, NO2_NO3, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, NH4, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, SiO4, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, Klorofyll, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, TotP, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, TotN, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, POC, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, PON, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, POP, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, TSM, color = Depth)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

ggplot(df_hydro_summ_q, aes(Year, -Siktdyp)) +
  geom_smooth(method = "lm") + 
  geom_point() +
  facet_grid(.~Quarter, labeller = label_both)

# plot variable by quartes vr year
#gg1 <- df_hydro_summ_q %>% 
 # filter(Depth %in% "Surface") %>% 
  #ggplot  (aes(Year, Temperatur)) +
  #geom_smooth() + geom_point() +
   #facet_wrap(~Quarter)
#gg1

```

### e. Plot flere variabler i samme plot.
```{r}
#str (df_hydro_summ_a)

#labeller = label_both
# mutate(Var=case_when(var=="Temperatur"~"Temperature", ), )  %>%
#geom_ma(ma_fun = SMA, n = 5, linetype = 1, size = 1) + 

# annual
df_hydro_summ_a %>%
  gather("Var", "Concentration", Temperatur, Salt, O2) %>%
  mutate(Var=factor(Var, levels = c("Temperatur", "Salt", "O2")))  %>%
  ggplot(aes(Year, Concentration, color = Depth)) +
    geom_smooth(method = "lm") +
    geom_point() +
    facet_wrap(~Var, scales = "free_y")

ggsave ("Figures_rapp/Hydro_1.png", width = 8, height = 6, dpi=500)

#summere inorg N
df_hydro_summ_a$DIN <- df_hydro_summ_a$NO2_NO3 + df_hydro_summ_a$NH4

df_hydro_summ_a %>%
  gather("Var", "Concentration", DIN, PO4, SiO4) %>%
  #mutate(Var=factor(Var, levels = c("DIN", "PO4", "SiO4")))  %>%
  ggplot(aes(Year, Concentration, color = Depth)) +
    geom_smooth(method = "lm") +
    geom_point() +
    facet_wrap(~Var, scales = "free_y")

ggsave ("Figures_rapp/Hydro_1.png", width = 8, height = 6, dpi=500)

df_hydro_summ_a %>%
  gather("Var", "Concentration", Klorofyll, TotP, TotN, Siktdyp) %>%
  mutate(Var=factor(Var, levels = c("Klorofyll", "TotN", "TotP", "Siktdyp")))  %>%
  ggplot(aes(Year, Concentration, color = Depth)) +
    geom_smooth(method = "lm") +
    geom_point() +
    facet_wrap(~Var, scales = "free_y")

ggsave ("Figures_rapp/Hydro_3.png", width = 8, height = 6, dpi=500)

df_hydro_summ_a %>%
  gather("Var", "Concentration", POC, PON, POP, TSM) %>%
  #mutate(Var=factor(Var, levels = c("Temperatur", "Salt", "O2")))  %>%
  ggplot(aes(Year, Concentration, color = Depth)) +
    geom_smooth(method = "lm") +
    geom_point() +
    facet_wrap(~Var, scales = "free_y")

ggsave ("Figures_rapp/Hydro_4.png", width = 8, height = 6, dpi=500)
 

# by quarters
df_hydro_summ_q %>%
  gather("Var", "Concentration", Temperatur, Salt, O2) %>%
   mutate(Var=factor(Var, levels = c("Temperatur", "Salt", "O2")))  %>%
  ggplot(aes(Year, Concentration, color = Depth)) +
    geom_smooth(method = "lm") + 
    geom_point() +
    facet_grid(Var~Quarter, scales = "free_y")

ggsave ("Figures_rapp/Hydro_q_1.png", width = 8, height = 6, dpi=500)

#summere inorg N
df_hydro_summ_q$DIN <- df_hydro_summ_q$NO2_NO3 + df_hydro_summ_q$NH4

df_hydro_summ_q %>%
  gather("Var", "Concentration", DIN, PO4, SiO4) %>%
   #mutate(Var=factor(Var, levels = c("DIN", "PO4", "Si")))  %>%
  ggplot(aes(Year, Concentration, color = Depth)) +
    geom_smooth(method = "lm") + 
    geom_point() +
    facet_grid(Var~Quarter, scales = "free_y")

ggsave ("Figures_rapp/Hydro_q_2.png", width = 8, height = 6, dpi=500)

df_hydro_summ_q %>%
  gather("Var", "Concentration", Klorofyll, TotP, TotN, Siktdyp) %>%
   mutate(Var=factor(Var, levels = c("Klorofyll", "TotN", "TotP", "Siktdyp")))  %>%
  ggplot(aes(Year, Concentration, color = Depth)) +
    geom_smooth(method = "lm") + 
    geom_point() +
    facet_grid(Var~Quarter, scales = "free_y")

ggsave ("Figures_rapp/Hydro_q_3.png", width = 8, height = 6, dpi=500)

df_hydro_summ_q %>%
  gather("Var", "Concentration", POC, PON, POP, TSM) %>%
  #mutate(Var=factor(Var, levels = c("Klorofyll", "TotN", "TotP", "O2")))  %>%
  ggplot(aes(Year, Concentration, color = Depth)) +
    geom_smooth(method = "lm") + 
    geom_point() +
    facet_grid(Var~Quarter, scales = "free_y")

ggsave ("Figures_rapp/Hydro_q_4.png", width = 8, height = 6, dpi=500)

```

## 4. Plankton  
Summarize main groups only  
    * Will add ordination scores (DCA) later
    
### a. Read plankton data
```{r}
df_plank <- read_excel("Datasett/Plankton/Planteplankton Arendal.xlsx") # range = "A1:V471"
df_plank$Year <- lubridate::year(df_plank$Dato)
df_plank$Month <- lubridate::month(df_plank$Dato)
```

### b. Plankton: Select by depth  
0-30 or 5 m  
```{r}
xtabs(~Dyp, df_plank)

# Select
sel <- df_plank$Dyp %in% c("0-30 m", "5 m", "5m"); 
df_plank <- df_plank[sel,]

# Stats
cat("Select", sum(sel), "lines\n")
cat(mean(sel)*100, "% of the data")
```

### c. Summarize data  
As hydrological data (section 3b), use quarters starting with February (see script 04, plot in section 3b) 
```{r}
df_plank_summ_a <- df_plank %>%
  mutate(Total = Kiselalger + Dinoflagellater + Flagellater) %>%
  group_by(Year) %>%
  summarize_at(.vars = vars(Kiselalger:Flagellater, Total), 
               .funs = funs(med = median, max = max)
               )

df_plank_summ_q <- df_plank %>%
  mutate(
    Quarter = case_when(
      Month %in% 1 ~ 4,
      Month %in% 2:4 ~ 1,
      Month %in% 5:7 ~ 2,
      Month %in% 8:10 ~ 3,
      Month %in% 11:12 ~ 4),
    Year2 = case_when(
      Month == 1 ~ Year - 1,
      Month > 1 ~ Year),
    Total = Kiselalger + Dinoflagellater + Flagellater
    ) %>%
  group_by(Year2, Quarter) %>%
  summarize_at(.vars = vars(Kiselalger:Flagellater, Total), 
               .funs = funs(med = median, max = max)
               ) %>%
  rename(Year = Year2)

```

### d. Save
```{r}
write.csv(df_plank_summ_a, "Data_produced/05_df_plank_summ_a.csv", row.names = FALSE, quote = FALSE)
write.csv(df_plank_summ_q, "Data_produced/05_df_plank_summ_q.csv", row.names = FALSE, quote = FALSE)
```


### e1. Plot medians by year
```{r}
df_plank_summ_q %>%
  gather("Group", "Median", Kiselalger_med:Total_med) %>%
  ggplot(aes(Year, Median/1E6)) +
    geom_smooth(method = "lm") + geom_point() +
    facet_grid(Group~., scales = "free_y")
```


### e2. Plot medians by quarter
```{r}
df_plank_summ_q %>%
  gather("Group", "Median", Kiselalger_med:Total_med) %>%
  mutate(Quarter = paste("Quarter", Quarter)) %>%
  ggplot(aes(Year, Median/1E6)) +
    geom_smooth(method = "lm") + geom_point() +
    facet_grid(Group~Quarter, scales = "free_y")
```
### f. Plot maxima
```{r}
df_plank_summ_q %>%
  gather("Group", "Maximum", Kiselalger_max:Total_max) %>%
  mutate(Quarter = paste("Quarter", Quarter)) %>%
  ggplot(aes(Year, Maximum/1E6)) +
    geom_smooth(method = "lm") + geom_point() +
    facet_grid(Group~Quarter, scales = "free_y")
```


