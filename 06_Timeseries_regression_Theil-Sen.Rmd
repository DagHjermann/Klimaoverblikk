---
title: "06 - Time series regressions using Mann-Kendall and Theil-Sen"
output:
  html_document:
    keep_md: true
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: hide
    df_print: paged   
---

Non-parametric tests for trends over time  
* Performed both on
    + Annual data (ending in _a, plus rivergroup_springflood)
    + Seasonal data (for seasons separately)
* For seasonal data, note that hydrography + plankton seasons start in February in order to get a "full spring bloom" in quarter 1 from February to April
* Uses data from script 05  
* Test = Mann-Kendall trend test (for P) and Theil-Sen's slope estimator (for percent change per year)   


DHJ: you borrowed much of this code from   'file:///C:/Data/Referanseelver_2018/Climate/05_Analysis_gridded_data_MK_TheilSen.html'    



## 0. Libraries
```{r}
library(tidyverse)
library(readxl)
library(broom)
library(lubridate)
# install.packages("rkt")
library(rkt)        # rkt() - computes the Mann-Kendall tests and Theil-Sen's slope estimator

#citation ("rkt")
#citation ("ggplot2")

# library(pander)
```

## 1. Data (annual and partly seasonal)  
### a. Read data
```{r}
df_rivers_summ_a <- read.csv("Data_produced/05_df_rivers_summ_a.csv")
df_rivergroup_springflood <- read.csv("Data_produced/05_df_rivergroup_springflood.csv")
df_hydro_summ_a <- read.csv("Data_produced/05_df_hydro_summ_a.csv")
df_plank_summ_a <- read.csv("Data_produced/05_df_plank_summ_a.csv")

```

### b. Collect data  
* River data
    + discharge divided by 1 million, the rest divided by 1000
```{r}
str(df_rivers_summ_a)

df1a <- df_rivers_summ_a %>%
  mutate(DisTot = Discharge/1E3) %>%
  gather("Variable", "Value", TotN:Discharge) %>%
  mutate(River_type = paste0("River_", River_type),
         Variable = sub("TrspTot_", "", Variable, fixed = TRUE)) %>%
  mutate(Variable = paste0(River_type, "_", Variable),
         Value = Value/1E3) %>%
  select(Variable, Year, Value)

# head(df1a)
#df1 %>% group_by(Variable) %>% summarise(mean(Value, na.rm = TRUE))

df1b <- df_rivergroup_springflood %>%
  rename(Floodmax = DisTot_max_rel, FloodmaxMonth = DisTot_max_month) %>%
  gather("Variable", "Value", Floodmax, FloodmaxMonth) %>%
  mutate(River_type = paste0("River_", River_type)) %>%
  mutate(Variable = paste0(River_type, "_", Variable)) %>%
  select(Variable, Year, Value)
# head(df1b)

str(df_hydro_summ_a)
df2 <- df_hydro_summ_a %>%
  gather("Variable", "Value", Temperature, Salinity, O2, PO4, Si, Chla:DIN) %>%
  mutate(Variable = paste0(Variable, "_", Depth)) %>%
  filter(!(Variable %in% c("Secchi_Intermediate", "Secchi_Deep"))) %>%
  select(Variable, Year, Value)

 #head(df2)

df3 <- df_plank_summ_a %>%
  gather("Variable", "Value", Kiselalger_med:Total_med) %>%
  select(Variable, Year,Value)
# head(df3)


dat_a <- rbind(df1a, df1b, df2, df3) %>% as.data.frame()
#head(dat_a)
```

### c. Read quarterly data
```{r}
df_rivers_summ_q <- read.csv("Data_produced/05_df_rivers_summ_q.csv")
df_hydro_summ_q <- read.csv("Data_produced/05_df_hydro_summ_q.csv")
df_plank_summ_q <- read.csv("Data_produced/05_df_plank_summ_q.csv")

str (df_rivers_summ_q)
```

### d. Collect quarterly data  
* River data
    + discharge divided by 1 million, the rest divided by 1000
```{r}
df1 <- df_rivers_summ_q %>%
  mutate(Discharge = Discharge/1E3) %>%
  gather("Variable", "Value", TotN:Discharge) %>%
  mutate(River_type = paste0("River_", River_type),
         Variable = sub("TrspTot_", "", Variable, fixed = TRUE)) %>%
  mutate(Variable = paste0(River_type, "_", Variable),
         Value = Value/1E3) %>%
  select(Variable, Year, Quarter, Value)

head(df1)
df1 %>% group_by(Variable) %>% summarise(mean(Value, na.rm = TRUE))

#str(df_hydro_summ_q)
df2 <- df_hydro_summ_q %>%
  gather("Variable", "Value", Temperature, Salinity, O2, PO4, Si, Chla:DIN) %>%
  mutate(Variable = paste0(Variable, "_", Depth)) %>%
  filter(!(Variable %in% c("Secchi_Intermediate", "Secchi_Deep"))) %>%
  select(Variable, Year, Quarter, Value) %>%
  select(Variable, Year, Quarter, Value)

#head(df2)

df3 <- df_plank_summ_q %>%
  gather("Variable", "Value", Kiselalger_med:Total_med) %>%
  select(Variable, Year, Quarter, Value)
head(df3)

dat_q <- rbind(df1, df2, df3) %>% as.data.frame()
```

e. Save collected data
```{r}
write.csv(dat_a, "Data_produced/06_dat_a.csv", row.names = FALSE, quote = FALSE)
write.csv(dat_q, "Data_produced/06_dat_q.csv", row.names = FALSE, quote = FALSE)

```

## 3a. Define trend analysis functions
One for annual data, one for seasonal
```{r}

trend_analysis_a <- function(variable, data = dat_a){
  df <- data %>%
    filter(Variable %in% variable & !is.na(Value))
  result <- rkt(df$Year, df$Value)
  data.frame(Variable = variable, Quarter = "Annual", 
             P = result$sl, Estimate = result$B, 
             Change_perc = 100*result$B/quantile(df$Value, 0.5), stringsAsFactors = FALSE)
}

#debugonce(trend_analysis_a)
#trend_analysis_a("River_Distant_TOTN")

trend_analysis_q <- function(variable, quarter, data = dat_q){
  df <- data %>%
    filter(Variable %in% variable & Quarter %in% quarter & !is.na(Value))
  result <- rkt(df$Year, df$Value)
  data.frame(Variable = variable, Quarter = as.character(quarter), 
             P = result$sl, Estimate = result$B, 
             Change_perc = 100*result$B/quantile(df$Value, 0.5), stringsAsFactors = FALSE)
}

#trend_analysis_q("River_Distant_TOTN", 2)

```

## 3b. Annual data, perform analysis  
```{r}
# ?map

df <- dat_a %>%
  filter(!is.na(Value)) %>%
  group_by(Variable) %>%
  summarise(N = n()) %>%
  filter(N >= 8)
 
df_result_list <-  1:nrow(df) %>% map(~trend_analysis_a(df$Variable[.], data = dat_a))

df_result_a <- bind_rows(df_result_list)


```


## 3c. Quarterly data, perform analysis  
```{r}
# ?map
df <- dat_q %>%
  filter(!is.na(Value)) %>%
  group_by(Variable, Quarter) %>%
  summarise(N = n()) %>%
  filter(N >= 8)
 df_result_list <- 
  1:nrow(df) %>% map(~trend_analysis_q(df$Variable[.], df$Quarter[.], data = dat_q))
 df_result_q <- bind_rows(df_result_list)

```


## 4. Show results
### a. Most extreme changes
```{r}

# head = mest negative = stï¿½rst reduksjon over tid.
df_result_q %>% arrange(Change_perc) %>% tail()
df_result_q %>% arrange(Change_perc) %>% head()

```

## 5. Save results
```{r}

write.csv(df_result_a, "Data_produced/06_df_result_a.csv",
          row.names = FALSE, quote = FALSE)
write.csv(df_result_q, "Data_produced/06_df_result_q.csv",
          row.names = FALSE, quote = FALSE)
```

## 6. Some plots
### a. Dot plot theme
```{r}
# Code and theme from http://www.joyce-robbins.com/blog/2016/06/02/datavis-with-rdrawing-a-cleveland-dot-plot-with-ggplot2/
theme_dotplot <- theme_bw(14) +
    theme(axis.text.y = element_text(size = rel(.75)),
    	axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(.75)),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5),
        panel.grid.minor.x = element_blank())
```

### b. Plot one season
```{r, fig.height=9}
qrt <- 2        
df <- df_result_q %>% filter(Quarter == qrt) 

ggplot(df, aes(x = Change_perc, y = reorder(Variable, Change_perc), size = factor(P < 0.05))) +
	geom_point(color = "blue") +
	scale_x_continuous(limits = c(-12, 4), breaks = seq(-12, 4, 2)) +
  scale_size_manual(values = c(2,4)) +
	# scale_size_continuous(limits = c(-12, 4), breaks = seq(-12, 4, 2)) +
	theme_dotplot +
	xlab("\nChange per year (%)") +
	ylab("Variable\n") +
	ggtitle(paste("Changes in quarter", qrt))
```


### c. Plot for all seasons
```{r, fig.width = 7, fig.height=9}
df_mean <- df_result_q  %>%
  group_by(Variable) %>%
  summarise(Mean_change = mean(Change_perc)) %>%
  arrange(Mean_change)

df <- df_result_q
df$Variable <- factor(df$Variable, levels = df_mean$Variable)
df$Quarter <- factor(df$Quarter)
df$P <- factor(df$P < 0.05, labels = c("Not significant", "Significant"))
# range(df$Change_perc)

cols <- RColorBrewer::brewer.pal(4, "RdBu")[c(3,4,1,2)]

# create the plot
ggplot(df, aes(x = Change_perc, y = Variable, fill = Quarter, size = P)) +
  geom_vline(xintercept = 0) +
	geom_point(pch = 21) +
  # scale_color_brewer(palette = "RdBu", direction = -1) +
  scale_fill_manual(values = cols) +
  scale_size_manual("Trend test", values = c(2.5,4)) +
	scale_x_continuous(limits = c(-11, 7), breaks = seq(-10, 6, 2)) +
	theme_dotplot +
	xlab("\nChange per year (%)") +
	ylab("Variable\n")

ggsave ("Figures_rapp/MannKendall_q.png", width = 7, height = 8, dpi=500)

```

### d. Plot trends for annual data
```{r, fig.width = 7, fig.height=9}
# create the plot
df <- df_result_a
df$P <- factor(df$P < 0.05, labels = c("Not significant", "Significant"))
# range(df$Change_perc)

ggplot(df, aes(x = Change_perc, y = reorder(Variable, Change_perc), fill = P, size = P)) +
  geom_vline(xintercept = 0) +
	geom_point(pch = 21) +
  scale_fill_manual("Trend test", values = c("lightblue", "firebrick")) +
  scale_size_manual("Trend test", values = c(2.5,4)) +
	scale_x_continuous(limits = c(-11, 4), breaks = seq(-10, 4, 2)) +
	theme_dotplot +
	xlab("\nChange per year (%)") +
	ylab("Variable\n") +
	ggtitle("Changes in annual means")

ggsave ("Figures_rapp/MannKendall_a.png", width = 7, height = 9, dpi=500)


```
