---
title: "Organising soft-bottom data for PCA"
output: 
  html_document:
    keep_md: true
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: hide
    df_print: paged    
---


## 0. Libraries
```{r}
library(readxl)
#install.packages("tidyverse")
library(tidyverse)
#install.packages("vegan")
library(vegan)
```

### Function for finding text in R files  
```{r}

search_text <- function(string, dir = ".", extension = c("R","Rmd"), pattern = NULL, fixed = FALSE, ignore.case = TRUE, deep = FALSE){
  if (!is.null(extension) & !is.null(pattern))
    warning("Pattern will take predence over extension")
  if (is.null(pattern)) {
    ext <- paste(extension, collapse = "|")
    pattern <- paste0("\\.(", paste(extension, collapse = '|'), ")$")
	}
  fn <- list.files(path = dir, pattern = pattern, full.names = TRUE, recursive = deep)
  search <- plyr::alply(fn, 1, function(x) grep(string,  readLines(x, warn = FALSE), fixed = fixed, ignore.case = ignore.case), .progress = "text")
  fn[plyr::laply(search, length) > 0]	
  }
```

## 1. Check organisation/analysis of hard-bottom data from Guri's scripts   
### a. Content of folders (see code)  
```{r}
dir("Datasett/hardbunn_kopi")
dir("Datasett/hardbunn_kopi/r workspace")
#
# Used this to explore where different data sets occur:
# search_text("ord1.df", "Datasett/hardbunn_kopi/r workspace")
# 
```

### b. Read 'transekt.df' which Guri used for ordination  
Does not include ord1.df, which is used in 'Klimaoverblikk_hardbunn.Rmd', but does include a lot of other stuff...  
Order of Guri's scripts:  
1) HBdata.R: HBdata -> Hbuse  
2) HBOrdinasjon.R: Hbuse -> HBagg -> transekt.df -> SiteSpec -> spec.m -> ordinasjon -> ord1.df  
```{r}
load("Datasett/hardbunn_kopi/r workspace/.RData")

# Let us delete everything except transekt.df
obj <- ls()
rm(list = obj[!obj %in% c("transekt.df")])

str(transekt.df)
```

### c. Create data for ordination ('spec.m') and perform ordination   
From Guri's code in 'HBOrdinasjon.R', except the first part     
* 'transekt.df' is in 'long format'  
* Is reshaped to broad format ('SiteSpec'). *Note* that this one is later combined with PCA output to create 'ord1.df'   
* For the ordination, the year and site columns are removed and NA -> 0 ('spec.m')   
```{r, warning=FALSE}
# table(transekt.df$Sitename)
transekt.df <- transekt.df %>%
  mutate(Site = substr(Sitename, 1,3), Year = as.numeric(substr(Sitename, 5,8))) %>%
  select(Site, Year, Species, Value)
# names(transekt.df) = c("Site", "Year", "Species", "Value")

# gjor om til vidt format
SiteSpec = reshape(transekt.df, idvar = c("Site", "Year"), timevar = "Species", direction = "wide")
# names(SiteSpec)

# velger kun stasjonene med lengre tidsserie (02.11.2018) 407 og 410
SiteSpec = subset(SiteSpec, SiteSpec$Site %in% c("407", "410"))

# Endrer navnene
artsnavn = names(SiteSpec)[-c(1:2)]
artsnavn = gsub("Value.", "", artsnavn)
artsnavn = gsub(" \n", "", artsnavn)
# artsnavn

# artsmatrise
spec.m = SiteSpec[, -c(1:2)]
names(spec.m) = artsnavn

# må erstatte NA med 0
spec.m[is.na(spec.m)] = 0

cat("Dimensions of 'spec.m':\n", dim(spec.m))
```

### d. Perform ordination
```{r}
# Transekt
ord1 <- decorana(spec.m)

# Pretty longish output
# summary(ord1) # viser arts- og rutescorer

# Short output
summary(ord1, display = "none")

# Innledende NMDS - litt usikker på utfallet 
ord2 <- metaMDS(spec.m)


ord2

```
### e. Test plot 1
```{r}
plot(ord1) # sorte sirkler er sites, røde pluss er arter
```

### f. Test plot 2
```{r}
plot(ord1, display = "sites", type = "n")
points(ord1, display = "sites", pch = 21, col = "red", bg = "yellow")
```

### g. Make data set for the plots done in 'Klimaoverblikk_hardbunn.Rmd'  
```{r}
# trekker ut akseskorer så det kan kobles til stasjon og år... i.e. Sitename
ord1.sites <- data.frame(scores(ord1, display = "sites"))
ord1.df <- data.frame(SiteSpec[,c(1:2)], ord1.sites)

#str(ord1.df)

# NMDS
# trekker ut akseskorer så det kan kobles til stasjon og år... i.e. Sitename
ord2.sites <- data.frame(scores(ord2, display = "sites"))
ord2.df <- data.frame(SiteSpec[,c(1:2)], ord2.sites) 

```

### h. Redone plots done in 'Klimaoverblikk_hardbunn.Rmd'   
* *BUT* they look a bit different... so the input data are probably not identical  
```{r}
# Innledende DCA - litt usikker på utfallet  
DCAplot.1 <- ggplot(ord1.df, aes(DCA1, DCA2, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")

DCAplot.2 <- ggplot(ord1.df, aes(DCA3, DCA4, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")

DCAplot.1
DCAplot.2

# DCA aksene mot år
DCAplot_3 <- ord1.df %>%
  gather("DCA_axis", "Value", DCA1:DCA4) %>%
  ggplot(aes(Year, Value)) +
    geom_line() +
    facet_grid(Site~DCA_axis)

DCAplot_3

# Innledende NMDS

# NMDS aksene mot hverandre, fargekodet for år
NMDSplot_1 <- ggplot(ord2.df, aes(NMDS1, NMDS2, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")


NMDSplot_1

# NMDS aksene mot år
NMDSplot_2 <- ord2.df %>%
  gather("NMDS_axis", "Value", NMDS1:NMDS2) %>%
  ggplot(aes(Year, Value)) +
    geom_line() +
    facet_grid(Site~NMDS_axis)

NMDSplot_2
```

### i. FOR USE: Loading data from HBanalysesett.csv and plotting. Faster, and that way the NMDS-results won't be different each time the script is run  
```{r}
HBdata <- read.csv("Datasett/Hardbunn_KOPI/HBanalysesett.csv", sep=";", stringsAsFactors = FALSE, dec=",")
HBdata_long <- subset(HBdata, HBdata$Site %in% c(407,410))

# DCA - transektdata, fargekodet for år  
DCAplot.1 <- ggplot(HBdata_long, aes(DCA1, DCA2, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")

DCAplot.2 <- ggplot(HBdata_long, aes(DCA3, DCA4, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")

DCAplot.1
DCAplot.2

# DCA aksene mot år
DCAplot_3 <- HBdata_long %>%
  gather("DCA_axis", "Value", DCA1:DCA4) %>%
  ggplot(aes(Year, Value)) +
    geom_line() +
    facet_grid(Site~DCA_axis)

DCAplot_3

# Innledende NMDS

# NMDS aksene mot hverandre, fargekodet for år
NMDSplot_1 <- ggplot(HBdata_long, aes(NMDS1, NMDS2, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")


NMDSplot_1

# NMDS aksene mot år
NMDSplot_2 <- HBdata_long %>%
  gather("NMDS_axis", "Value", NMDS1:NMDS2) %>%
  ggplot(aes(Year, Value)) +
    geom_line() +
    facet_grid(Site~NMDS_axis)

NMDSplot_2
```

## 2. Reorganise soft-bottom fauna data and test ordination
### a. Data
```{r}
df_blot_b35 <- read_excel("Datasett/Bløtbunn/Klimaoverblikk bløtbunn_data til Helene og Dag.xlsx", sheet = "B35_artsliste")
colnames(df_blot_b35)[1] <- "Species"

df_blot_b05 <- read_excel("Datasett/Bløtbunn/Klimaoverblikk bløtbunn_data til Helene og Dag.xlsx", sheet = "B05_artsliste")
colnames(df_blot_b05)[1] <- "Species"

df_blot_ind <- read_excel("Datasett/Bløtbunn/Klimaoverblikk bløtbunn_data til Helene og Dag.xlsx", sheet = "indekser_sedimentparametere")

cat("b35, number of species:", nrow(df_blot_b35), ", Number of years:", ncol(df_blot_b35), "\n")
cat("b05, number of species:", nrow(df_blot_b05), ", Number of years:", ncol(df_blot_b05), "\n")


```

### b. Put on data long format, combine, and extract Site and Year separately
```{r}
df_long_1 <- df_blot_b05 %>%
  gather("Siteyear", "Value", B05_1990:B05_2016)
df_long_2 <- df_blot_b35 %>%
  gather("Siteyear", "Value", B35_1990:B35_2016)

df_long <- bind_rows(df_long_1, df_long_2) %>%
  mutate(Site = substr(Siteyear, 1,3), Year = as.numeric(substr(Siteyear, 5,8))) %>%
  select(Site, Year, Species, Value)

str(df_long)
head (df_long)
# look at data
tb <- xtabs(~Year + Site, df_long)
pandoc.table(tb, style = "rmarkdown")

```

### c. Reshape for ordination  
Reshape to wide format the tidyr way (instead of using reshape()) - gives us nice column names right away  
```{r}
SiteSpec <- df_long %>%
  spread(Species, Value)

head(SiteSpec)

# må erstatte NA med 0
SiteSpec[is.na(SiteSpec)] = 0

# lager separate artsmatriser for de to ulike stasjonene (representerer ulike system)
spec_05 <- filter (SiteSpec, Site == "B05")
spec_35 <- filter (SiteSpec, Site == "B35")

# artsmatrise, fjerner år og stasjon
spec.m_05 = spec.m_05[, -c(1:2)]
spec.m_35 = spec.m_35[, -c(1:2)]

cat("Dimensions of 'spec.m_05':\n", dim(spec.m_05))

```

### d. Perform ordination
```{r}
# Innledende DCA - litt usikker på utfallet 
ord1_05 <- decorana(spec.m_05)
ord1_35 <- decorana(spec.m_35)

# Pretty longish output
# summary(ord1) # viser arts- og rutescorer

# Short output
summary(ord1_05, display = "none")
summary(ord1_35, display = "none")

# Innledende NMDS - litt usikker på utfallet 
ord2_05 <- metaMDS(spec.m_05)
ord2_35 <- metaMDS(spec.m_35)

ord2_05
ord2_35 

```
### e. Test plot 1
```{r}
# sorte sirkler er sites, røde pluss er arter

# DCA
plot(ord1_05) 
plot(ord1_35) 
# NMDS
plot(ord2_05)
plot(ord2_35)

```

### f. Test plot 2
```{r}
# DCA
plot(ord1_05, display = "sites", type = "n")
points(ord1_05, display = "sites", pch = 21, col = "red", bg = "yellow")

plot(ord1_35, display = "sites", type = "n")
points(ord1_35, display = "sites", pch = 21, col = "red", bg = "yellow")

# NMDS
plot(ord2_05, display = "sites", type = "n")
points(ord2_05, display = "sites", pch = 21, col = "red", bg = "yellow")

plot(ord2_35, display = "sites", type = "n")
points(ord2_35, display = "sites", pch = 21, col = "red", bg = "yellow")

```

### g. Make data set for ggplot
```{r}
# DCA
# trekker ut akseskorer så det kan kobles til stasjon og år... i.e. Sitename
ord1_05.sites <- data.frame(scores(ord1_05, display = "sites"))
ord1_05.df <- data.frame(spec_05[,c(1:2)], ord1_05.sites)

ord1_35.sites <- data.frame(scores(ord1_35, display = "sites"))
ord1_35.df <- data.frame(spec_35[,c(1:2)], ord1_35.sites)

str(ord1_05.df)
str(ord1_35.df)

# legger DCA-aksene for de to stasjonene sammen igjen (etter at ordinasjon er gjort separat)
ord1_both <- bind_rows(ord1_05.df, ord1_35.df)

# NMDS
# trekker ut akseskorer så det kan kobles til stasjon og år... i.e. Sitename
ord2_05.sites <- data.frame(scores(ord2_05, display = "sites"))
ord2_05.df <- data.frame(spec_05[,c(1:2)], ord2_05.sites) 

ord2_35.sites <- data.frame(scores(ord2_35, display = "sites"))
ord2_35.df <- data.frame(spec_35[,c(1:2)], ord2_35.sites)

# legger NMDS-aksene for de to stasjonene sammen igjen (etter at ordinasjon er gjort separat)
ord2_both <- bind_rows(ord2_05.df, ord2_35.df)

```

### h. Redone ggplots similar to 'Klimaoverblikk_hardbunn.Rmd'   
```{r}

# DCA aksene mot hverandre, fargekodet for år
DCAplot_1 <- ggplot(ord1_both, aes(DCA1, DCA2, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")

DCAplot_2 <- ggplot(ord1_both, aes(DCA3, DCA4, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")

DCAplot_1
DCAplot_2

# DCA aksene mot år
DCAplot_3 <- ord1_both %>%
  gather("DCA_axis", "Value", DCA1:DCA4) %>%
  ggplot(aes(Year, Value)) +
    geom_line() +
    facet_grid(Site~DCA_axis)

DCAplot_3

# Innledende NMDS

# NMDS aksene mot hverandre, fargekodet for år
NMDSplot_1 <- ggplot(ord2_both, aes(NMDS1, NMDS2, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")


NMDSplot_1

# NMDS aksene mot år
NMDSplot_2 <- ord2_both %>%
  gather("NMDS_axis", "Value", NMDS1:NMDS2) %>%
  ggplot(aes(Year, Value)) +
    geom_line() +
    facet_grid(Site~NMDS_axis)

NMDSplot_2

# for both DCA and NMDS the time correlated changes in species comp seems to be captured by the first axis. Note that there is opposite directions for the two stations for DCA1, does that matter?  

```



## 3. Reorganise phytoplankton data and test ordination
### a. Data
```{r}
df <- read_excel("Datasett/Plankton/Planteplankton Arendal.xlsx") # range = "A1:V471"
df$Year <- lubridate::year(df$Dato)
df$Month <- lubridate::month(df$Dato)
xtabs(~Year + Month, df)

# They used depth profiles (0-30m) before 2000, after 2000 they mostly sampled at 5m, but there are some dates where there are profiles after 2000 as well. See more info in data description.
df <- df %>% 
  select(Dato:Month) %>%
  filter(Dyp == "0-30 m" | Dyp == "5 m" | Dyp == "5m")

```


### c. Reshape for ordination  
Reshape to wide format the tidyr way (instead of using reshape()) - gives us nice column names right away  
```{r}

#dette datasettet er jo "wide" allerede
#SiteSpec <- df_long %>%
  #spread(Species, Value)

head (df,10)
str(df)

# artsmatrise (fjerner år og dyp (1:2) og grupper (18:20), år og mnd (21:22))
# NB! artsdata er her aggregert til 15 klasser. I tillegg aggregert til tre overordnete grupper (kisel, dinoflag, flagellater)
spec.m_phyto = df[, -c(1:2,18:22)]
str (spec.m_phyto)

# må erstatte NA med 0
spec.m_phyto[is.na(spec.m_phyto)] = 0

cat("Dimensions of 'spec.m_hyto':\n", dim(spec.m_phyto))
```

### d. Perform ordination
```{r}
# Innledende DCA - litt usikker på utfallet 
ord1 <- decorana(spec.m_phyto)
?decorana
# Pretty longish output
# summary(ord1) # viser arts- og rutescorer

# Short output
summary(ord1, display = "none")

# Innledende NMDS - litt usikker på utfallet 
ord2 <- metaMDS(spec.m_phyto)

 ord2
 

```
### e. Test plot 1
```{r}



# sorte sirkler er sites, røde pluss er arter
#######NB! her stoppet jeg opp, usikker på videre plotting og tolking, siden dette kun er EN stasjon (sites/species???) Resten under dette er bare kopiert fra over, og ikke tilpasset Plankton

# DCA
plot(ord1) 

# NMDS
plot(ord2)

```

### f. Test plot 2
```{r}
# DCA
plot(ord1, display = "sites", type = "n")
points(ord1, display = "sites", pch = 21, col = "red", bg = "yellow")

# NMDS
plot(ord2, display = "sites", type = "n")
points(ord2, display = "sites", pch = 21, col = "red", bg = "yellow")

```

### g. Make data set for ggplot
```{r}
# DCA
# trekker ut akseskorer så det kan kobles til mnd og år... i.e. Sitename
ord1.sites <- data.frame(scores(ord1, display = "sites"))

ord1.df <- data.frame(df[,c(1:2)], ord1.sites)

str(ord1.df)

# NMDS
# trekker ut akseskorer så det kan kobles til stasjon og år... i.e. Sitename
ord2.sites <- data.frame(scores(ord2, display = "sites"))

ord2.df <- data.frame(df[,c(1:2)], ord2.sites)

str(ord2.df)

```

### h. Redone ggplots similar to 'Klimaoverblikk_hardbunn.Rmd'   
```{r}
# Innledende DCA 
DCAplot.1 <- ggplot(ord1.df, aes(DCA1, DCA2, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")

DCAplot.2 <- ggplot(ord1.df, aes(DCA3, DCA4, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")

DCAplot.1
DCAplot.2

# Plotte akser mot tid

DCAplot.3 <- ggplot(ord1.df, aes(Year, DCA1)) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2)

DCAplot.4 <- ggplot(ord1.df, aes(Year, DCA2)) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2)

DCAplot.5 <- ggplot(ord1.df, aes(Year, DCA3)) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2)

DCAplot.6 <- ggplot(ord1.df, aes(Year, DCA4)) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2)

DCAplot.3
DCAplot.4
DCAplot.5
DCAplot.6


# Innledende NMDS 
NMDSplot.1 <- ggplot(ord2.df, aes(NMDS1, NMDS2, color = as.numeric(as.character(Year)))) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2) +
  labs(color = "År")

NMDSplot.1

# Plotte akser mot tid

NMDSplot.2 <- ggplot(ord2.df, aes(Year, NMDS1)) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2)

NMDSplot.3 <- ggplot(ord2.df, aes(Year, NMDS2)) + 
  geom_point() + 
  facet_wrap(~ Site, nrow=2)

NMDSplot.2
NMDSplot.3


```

